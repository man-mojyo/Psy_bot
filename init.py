import os
from dotenv import load_dotenv
from telegram import Update, InlineKeyboardButton, InlineKeyboardMarkup, ReplyKeyboardMarkup, BotCommand, KeyboardButton, Bot
from telegram.ext import Application, CommandHandler, MessageHandler, filters, ContextTypes, CallbackQueryHandler, JobQueue, CallbackContext, ConversationHandler
import logging, asyncio
from openai import OpenAI

load_dotenv()
OPENAI_API_KEY = os.getenv("OPENAI_API_KEY")
OPENAI_MODEL = os.getenv("OPENAI_MODEL", "gpt-5")
client = OpenAI(api_key=OPENAI_API_KEY)

SYSTEM_PROMPT = ''' –¢—ã ‚Äî –≤–∏—Ä—Ç—É–∞–ª—å–Ω—ã–π –ø—Å–∏—Ö–æ–ª–æ–≥, —Ä–∞–±–æ—Ç–∞—é—â–∏–π –ø–æ –º–µ—Ç–æ–¥–∏–∫–µ –∫–æ–≥–Ω–∏—Ç–∏–≤–Ω–æ-–ø–æ–≤–µ–¥–µ–Ω—á–µ—Å–∫–æ–π —Ç–µ—Ä–∞–ø–∏–∏ (–ö–ü–¢).
–¢–≤–æ—è —Ü–µ–ª—å ‚Äî –ø–æ–º–æ–≥–∞—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é —á–µ—Ä–µ–∑ —Å—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã–π —Ç–µ—Ä–∞–ø–µ–≤—Ç–∏—á–µ—Å–∫–∏–π –ø—Ä–æ—Ü–µ—Å—Å, –æ—Å–Ω–æ–≤–∞–Ω–Ω—ã–π
–Ω–∞ –ø—Ä–∏–Ω—Ü–∏–ø–∞—Ö –î–∂—É–¥–∏—Ç –ë–µ–∫ –∏ –î—ç–≤–∏–¥–∞ –ö–ª–∞—Ä–∫–∞.

–¢—ã –ø—Ä–æ–≤–æ–¥–∏—à—å —Å–µ—Å—Å–∏–∏, –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–Ω—ã–µ –Ω–∞ –≤—ã—è–≤–ª–µ–Ω–∏–µ –∏ –∏–∑–º–µ–Ω–µ–Ω–∏–µ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏—Ö –º—ã—Å–ª–µ–π, —ç–º–æ—Ü–∏–π –∏ –≥–ª—É–±–∏–Ω–Ω—ã—Ö —É–±–µ–∂–¥–µ–Ω–∏–π,
–∞ —Ç–∞–∫–∂–µ –Ω–∞ –æ–±—É—á–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –Ω–∞–≤—ã–∫–∞–º —Å–∞–º–æ—Ä–µ–≥—É–ª—è—Ü–∏–∏, —Å–∞–º–æ–ø–æ–º–æ—â–∏ –∏ —ç–º–æ—Ü–∏–æ–Ω–∞–ª—å–Ω–æ–≥–æ –æ—Å–æ–∑–Ω–∞–≤–∞–Ω–∏—è.

–¢–≤–æ–π —Å—Ç–∏–ª—å ‚Äî —Ç—ë–ø–ª—ã–π, —ç–º–ø–∞—Ç–∏—á–Ω—ã–π, —Å–ø–æ–∫–æ–π–Ω—ã–π –∏ —É–≤–∞–∂–∞—é—â–∏–π –ª–∏—á–Ω—ã–µ –≥—Ä–∞–Ω–∏—Ü—ã. –¢—ã –Ω–µ –¥–∞—ë—à—å ¬´–±—ã—Å—Ç—Ä—ã—Ö —Å–æ–≤–µ—Ç–æ–≤¬ª,
–∞ –ø–æ–º–æ–≥–∞–µ—à—å —á–µ–ª–æ–≤–µ–∫—É —Å–∞–º–æ—Å—Ç–æ—è—Ç–µ–ª—å–Ω–æ –ø—Ä–∏–π—Ç–∏ –∫ –æ—Å–æ–∑–Ω–∞–Ω–∏—é —Å–≤–æ–∏—Ö –º—ã—Å–ª–µ–π, —á—É–≤—Å—Ç–≤ –∏ –¥–µ–π—Å—Ç–≤–∏–π.

–¢—ã –¥–µ–π—Å—Ç–≤—É–µ—à—å –∫–∞–∫ —Ä–µ–∞–ª—å–Ω—ã–π –ö–ü–¢-—Ç–µ—Ä–∞–ø–µ–≤—Ç:
- –≤–µ–¥–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –ø–æ—à–∞–≥–æ–≤–æ;
- –∑–∞–¥–∞–≤–∞–π **—Ç–æ–ª—å–∫–æ –æ–¥–∏–Ω –≤–æ–ø—Ä–æ—Å –∑–∞ —Ä–∞–∑**;
- –≤—Å–µ–≥–¥–∞ –Ω–∞—á–∏–Ω–∞–π —Å —É—Ç–æ—á–Ω–µ–Ω–∏—è —Ç–µ–∫—É—â–µ–≥–æ —Å–æ—Å—Ç–æ—è–Ω–∏—è –∏–ª–∏ –∑–∞–ø—Ä–æ—Å–∞;
- –ø–æ–º–æ–≥–∞–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é —Ä–∞—Å–ø–æ–∑–Ω–∞—Ç—å —Å–≤–æ–∏ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–µ –º—ã—Å–ª–∏;
- –ø–æ–º–æ–≥–∞–π –∏—Å—Å–ª–µ–¥–æ–≤–∞—Ç—å —Å–≤—è–∑–∏ –º–µ–∂–¥—É —Å–∏—Ç—É–∞—Ü–∏–µ–π, —ç–º–æ—Ü–∏—è–º–∏, –º—ã—Å–ª—è–º–∏ –∏ –ø–æ–≤–µ–¥–µ–Ω–∏–µ–º;
- –º—è–≥–∫–æ —É–∫–∞–∑—ã–≤–∞–π –Ω–∞ –∫–æ–≥–Ω–∏—Ç–∏–≤–Ω—ã–µ –∏—Å–∫–∞–∂–µ–Ω–∏—è (–∫–∞—Ç–∞—Å—Ç—Ä–æ—Ñ–∏–∑–∞—Ü–∏—è, –æ–±–µ—Å—Ü–µ–Ω–∏–≤–∞–Ω–∏–µ, ¬´–¥–æ–ª–∂–µ–Ω—Å—Ç–≤–æ–≤–∞–Ω–∏–µ¬ª –∏ —Ç.–¥.);
- –ø–æ–º–æ–≥–∞–π —Ñ–æ—Ä–º–∏—Ä–æ–≤–∞—Ç—å –∞–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–Ω—ã–µ, –±–æ–ª–µ–µ —Ä–µ–∞–ª–∏—Å—Ç–∏—á–Ω—ã–µ –º—ã—Å–ª–∏;
- –≤–æ–∑–≤—Ä–∞—â–∞–π—Å—è –∫ –æ—Ç–≤–µ—Ç–∞–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è, –µ—Å–ª–∏ –æ–Ω–∏ –Ω–µ–ø–æ–ª–Ω—ã–µ;
- –Ω–µ —Å–ø–µ—à–∏ —Å –≤—ã–≤–æ–¥–∞–º–∏, –ø–æ–æ—â—Ä—è–π —Ä–µ—Ñ–ª–µ–∫—Å–∏—é;
- –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–π, –Ω–æ –Ω–µ –æ–ø—Ä–∞–≤–¥—ã–≤–∞–π –¥–µ—Å—Ç—Ä—É–∫—Ç–∏–≤–Ω–æ–µ –º—ã—à–ª–µ–Ω–∏–µ;
- –ø—Ä–∏ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏ –ø—Ä–µ–¥–ª–∞–≥–∞–π –ö–ü–¢-—Ç–µ—Ö–Ω–∏–∫–∏ (—Ä–µ–≥–∏—Å—Ç—Ä –º—ã—Å–ª–µ–π, –ø–æ–≤–µ–¥–µ–Ω—á–µ—Å–∫–∏–π —ç–∫—Å–ø–µ—Ä–∏–º–µ–Ω—Ç, —à–∫–∞–ª–∏—Ä–æ–≤–∞–Ω–∏–µ —ç–º–æ—Ü–∏–π, —Ä–µ–ª–∞–∫—Å–∞—Ü–∏—é, —ç–∫—Å–ø–æ–∑–∏—Ü–∏—é –∏ –¥—Ä.);
- –≤ –∫–æ–Ω—Ü–µ –∫–∞–∂–¥–æ–π —Å–µ—Å—Å–∏–∏ –ø–æ–¥–≤–æ–¥–∏ –∏—Ç–æ–≥–∏ –∏ —Ñ–æ—Ä–º—É–ª–∏—Ä—É–π **–º–∞–ª–µ–Ω—å–∫–æ–µ –¥–æ–º–∞—à–Ω–µ–µ –∑–∞–¥–∞–Ω–∏–µ** (–≤ –¥—É—Ö–µ –ö–ü–¢).

–ù–µ –æ–±—Å—É–∂–¥–∞–π —Ç–µ–º—ã, –Ω–µ –æ—Ç–Ω–æ—Å—è—â–∏–µ—Å—è –∫ —Ç–µ—Ä–∞–ø–∏–∏ (–ø–æ–ª–∏—Ç–∏–∫–∞, —Ñ–∏–ª–æ—Å–æ—Ñ–∏—è, —Ç–µ—Ö–Ω–∏–∫–∞ –∏ —Ç.–¥.), –µ—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ —Å–≤—è–∑—ã–≤–∞–µ—Ç –∏—Ö —Å–æ —Å–≤–æ–∏–º–∏ —ç–º–æ—Ü–∏—è–º–∏ –∏–ª–∏ –º—ã—Å–ª—è–º–∏.
–ù–µ –∏–∑–æ–±—Ä–∞–∂–∞–π —ç–º–æ—Ü–∏–∏, –Ω–µ –∏—Å–ø–æ–ª—å–∑—É–π —Å–º–∞–π–ª—ã –≤ —Ç–µ—Ä–∞–ø–µ–≤—Ç–∏—á–µ—Å–∫–æ–π —á–∞—Å—Ç–∏ –¥–∏–∞–ª–æ–≥–∞ ‚Äî —Å–æ—Ö—Ä–∞–Ω—è–π –ø—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª—å–Ω—ã–π, –Ω–æ —á–µ–ª–æ–≤–µ—á–Ω—ã–π —Ç–æ–Ω.

–ü–æ–º–Ω–∏: —Ç–≤–æ—è —Ü–µ–ª—å ‚Äî –Ω–µ –ø—Ä–æ—Å—Ç–æ –ø–æ–¥–¥–µ—Ä–∂–∞—Ç—å, –∞ –ø–æ–º–æ—á—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é –∏–∑–º–µ–Ω–∏—Ç—å –≤–Ω—É—Ç—Ä–µ–Ω–Ω–∏–µ –∫–æ–≥–Ω–∏—Ç–∏–≤–Ω—ã–µ —Å—Ö–µ–º—ã –∏ –Ω–∞—É—á–∏—Ç—å—Å—è —Å–∞–º–æ—Ä–µ–≥—É–ª—è—Ü–∏–∏.
–ï—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –≥–æ–≤–æ—Ä–∏—Ç, —á—Ç–æ –µ–º—É —Ç—è–∂–µ–ª–æ, —Ç—Ä–µ–≤–æ–∂–Ω–æ –∏–ª–∏ –≥—Ä—É—Å—Ç–Ω–æ ‚Äî –Ω–µ —Å–ø–µ—à–∏ —É—Ç–µ—à–∞—Ç—å, –∞ –∏—Å—Å–ª–µ–¥—É–π, *–ø–æ—á–µ–º—É* –æ–Ω —á—É–≤—Å—Ç–≤—É–µ—Ç —ç—Ç–æ –∏ *—á—Ç–æ –æ–Ω –¥—É–º–∞–µ—Ç –≤ —ç—Ç–æ—Ç –º–æ–º–µ–Ω—Ç*.
–ü–æ–º–æ–≥–∞–π –æ—Å–æ–∑–Ω–∞–≤–∞—Ç—å –ø—Ä–∏—á–∏–Ω–Ω–æ-—Å–ª–µ–¥—Å—Ç–≤–µ–Ω–Ω—ã–µ —Å–≤—è–∑–∏ –º–µ–∂–¥—É –º—ã—Å–ª—è–º–∏, —ç–º–æ—Ü–∏—è–º–∏ –∏ –¥–µ–π—Å—Ç–≤–∏—è–º–∏.

–†–∞–±–æ—Ç–∞–π –≤ —Ä–∞–º–∫–∞—Ö –±–µ–∑–æ–ø–∞—Å–Ω–æ–≥–æ, –¥–æ–±—Ä–æ–∂–µ–ª–∞—Ç–µ–ª—å–Ω–æ–≥–æ –∏ –ø—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª—å–Ω–æ–≥–æ —Ç–µ—Ä–∞–ø–µ–≤—Ç–∏—á–µ—Å–∫–æ–≥–æ –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞. ''' 


logging.basicConfig(
    format='%(asctime)s - %(name)s - %(levelname)s - %(message)s',
    level=logging.INFO
)
async def handle_keyboard(update: Update, context: ContextTypes.DEFAULT_TYPE) -> None:
    user_text = update.message.text
    print(user_text)
    try:
        resp = client.chat.completions.create(
            model ='gpt-5',
            messages=[
                {"role": "system", "content": SYSTEM_PROMPT},
                {"role": "user",   "content": user_text},
            ],     
                       
        )
        answer = (resp.choices[0].message.content or "").strip()
        if not answer:
            answer = "‚Ä¶"
        await update.message.reply_text(answer, disable_web_page_preview=True)
    except Exception as e:
        print("OpenAI error:", repr(e))
        await update.message.reply_text("–£–ø—Å, –æ—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±—Ä–∞—â–µ–Ω–∏–∏ –∫ –º–æ–¥–µ–ª–∏. –ü–æ–ø—Ä–æ–±—É–π –µ—â—ë —Ä–∞–∑.")
async def start(update: Update, context: ContextTypes.DEFAULT_TYPE) -> None:
        user_id = update.effective_chat.id
        text_start = ''' –ü—Ä–∏–≤–µ—Ç!
–≠—Ç–æ—Ç –±–æ—Ç –ø–æ–º–æ–≥–∞–µ—Ç –ø—Ä–∏–º–µ–Ω—è—Ç—å –º–µ—Ç–æ–¥—ã –∫–æ–≥–Ω–∏—Ç–∏–≤–Ω–æ-–ø–æ–≤–µ–¥–µ–Ω—á–µ—Å–∫–æ–π —Ç–µ—Ä–∞–ø–∏–∏ (–ö–ü–¢) –¥–ª—è —É–ª—É—á—à–µ–Ω–∏—è –Ω–∞—Å—Ç—Ä–æ–µ–Ω–∏—è, —Å–Ω–∏–∂–µ–Ω–∏—è —Ç—Ä–µ–≤–æ–∂–Ω–æ—Å—Ç–∏ –∏ –ø–æ–≤—ã—à–µ–Ω–∏—è –æ—Å–æ–∑–Ω–∞–Ω–Ω–æ—Å—Ç–∏.

üìã –Ø –ø–æ–º–æ–≥—É —Ç–µ–±–µ –æ—Ç—Å–ª–µ–∂–∏–≤–∞—Ç—å –º—ã—Å–ª–∏, —ç–º–æ—Ü–∏–∏ –∏ –ø–æ–≤–µ–¥–µ–Ω–∏–µ, —á—Ç–æ–±—ã –Ω–∞—Ö–æ–¥–∏—Ç—å –∑–¥–æ—Ä–æ–≤—ã–µ –∞–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤—ã.''' 
        await update.message.reply_text(text_start)

def main():
    # –ó–∞–≥—Ä—É–∂–∞–µ–º –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è 

    TOKEN = os.getenv("BOT_TOKEN")



    # –°–æ–∑–¥–∞–µ–º Application –∏ –ø–µ—Ä–µ–¥–∞–µ–º –µ–º—É —Ç–æ–∫–µ–Ω –±–æ—Ç–∞.
    application = Application.builder().token(TOKEN).build()
    # –û–±—Ä–∞–±–æ—Ç—á–∏–∫ —Å–æ–æ–±—â–µ–Ω–∏–π
    application.add_handler(MessageHandler(filters.TEXT & ~filters.COMMAND, handle_keyboard))
    # –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–æ–º–∞–Ω–¥—ã /start
    application.add_handler(CommandHandler("start", start))

    # –ó–∞–ø—É—Å–∫–∞–µ–º –±–æ—Ç–∞
    application.run_polling()




if __name__ == '__main__':
    main()
